<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">


<link rel="import" href="../../behaviors/utils.html">
=
<link rel="import" href="../etools-prp-ajax.html">
<link rel="import" href="../../elements/disaggregations/disaggregation-table.html">
<link rel="import" href="../../elements/disaggregations/edit-disaggregation-modal.html">
<link rel="import" href="../../endpoints.html">

<dom-module id="ip-reporting-indicator-details">
  <template>
    <style include="iron-flex iron-flex-factors">
      :host {
        display: block;
      }
      iron-icon {
        color: var(--accent-color)
      }
      h3 {
        width: 100%;
        float: left;
      }
      h4 {
        font-weight: 400;
      }
      h4 span {
        color: gray;
        font-weight: 400;
      }
      .wrapper {
        float: left;
        margin: 0 10px 10px 10px;
        width: 100%;
      }
    </style>

    <etools-prp-ajax
        id="indicatorDetail"
        url="[[indicatorDetailUrl]]">
    </etools-prp-ajax>

    <etools-loading active="[[loading]]"></etools-loading>

    <!-- TODO: group data objects by location; only display location header once. -->

      <template is="dom-repeat"
                items="[[locations]]"
                as="location">

        <h3>
          <iron-icon icon="maps:place"></iron-icon>
          [[location.0.location.title]]
        </h3>

        <template is="dom-repeat"
                  items="[[location]]"
                  as="item">
          <div class="wrapper">
            <h4>
              Progress in reporting period
              <span>[[data.time_period_start]] - [[data.time_period_end]]<span>
            </h4>
            <h4>
              Total
              <span>[[data.total]]<span>
            </h4>

            <paper-button raised modal-id="[[_generateModalID(data.id, item.id)]]" on-tap="_openEditModal">Edit data</paper-button raised>

            <disaggregation-table
              total=[[data.total]]
              data=[[item]]
              mapping=[[data.disagg_lookup_map]]>
            </disaggregation-table>

            <edit-disaggregation-modal
              id="[[_generateModalID(data.id, item.id)]]"
              item=[[data]]
              data=[[item]]
              mapping=[[data.disagg_lookup_map]]>
            </edit-disaggregation-modal>
          </div>

        </template>

    </template>
  </template>

  <script>

    Polymer({
      is: 'ip-reporting-indicator-details',

      behaviors: [
        App.Behaviors.UtilsBehavior,
      ],

      properties: {
        indicatorDetailUrl: {
          type: String,
          computed: '_computeIndicatorReportsUrl(indicatorId)',
        },

        isOpen: {
          type: Boolean,
          observer: '_openChanged',
        },

        indicatorId: Number,

        loading: Boolean,

        data: {
          type: Object,
          value: {}
        },

        locations: {
          type: Array,
          computed: '_bucketByLocation(data)'
        }

      },

      _computeIndicatorReportsUrl: function (indicatorId) {
        return App.Endpoints.indicatorReports(indicatorId);
      },

      _generateModalID: function (indicator_id, location_id) {
        return 'ind' + indicator_id + 'loc' + location_id;
      },

      _bucketByLocation: function (data) {
        var self = this;
        locations = {};

        if (Object.keys(data).length > 0) {
          data.indicator_location_data.map(function (report) {

            if (locations[report.location.id]) {
              var currentArray = locations[report.location.id];
              var newArray = currentArray;
              newArray.push(report);
              locations[report.location.id] = newArray;
            } else {
              locations[report.location.id] = [report]
            }
          });
        }
        var locationList = [];
        var locationKeys = Object.keys(locations)

        Object.keys(locations).map(function (i) {
          locationList.push(locations[i]);
        })
        return locationList;
      },

      _openChanged: function () {
        var self = this;
        if (this.isOpen) {
          self.loading = true;
          this.$.indicatorDetail.thunk()()
            .then(function (res) {
              var data = res.data;

              //TODO: Remove when API doesn't return all permutations anymore.
              //Strips out the 1-2 unwanted objects (fakedata glitch):
              if (data.length === 6) {
                res.data.shift();
              }
              if (data.length === 5) {
                res.data.shift();
              }
              var numDisaggs = 0;
              self.data = res.data[numDisaggs];

              self.loading = false;
            });
            // TODO: error handling.
        } else {
          this.$.indicatorDetail.abort();
        }
      },

      _openEditModal: function (e) {
        var modalId = '#' + e.target.modalId;
        var el = Polymer.dom(this.root).querySelector(modalId);
        el.open();
      }


    });
  </script>
</dom-module>
