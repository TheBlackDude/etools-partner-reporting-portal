<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">


<link rel="import" href="../../behaviors/utils.html">
=
<link rel="import" href="../etools-prp-ajax.html">
<link rel="import" href="../../elements/disaggregations/disaggregation-table.html">
<link rel="import" href="../../endpoints.html">

<dom-module id="ip-reporting-indicator-details">
  <template>
    <style include="iron-flex iron-flex-factors">
      :host {
        display: block;
      }
      iron-icon {
        color: var(--accent-color)
      }
      h3 {
        width: 100%;
        float: left;
      }
      h4 {
        font-weight: 400;
      }
      h4 span {
        color: gray;
        font-weight: 400;
      }
      .wrapper {
        float: left;
        margin: 0 10px 10px 10px;
        width: 100%;
      }
    </style>

    <etools-prp-ajax
        id="indicatorDetail"
        url="[[indicatorDetailUrl]]">
    </etools-prp-ajax>

    <etools-loading active="[[loading]]"></etools-loading>

    <!-- TODO: group data objects by location; only display location header once. -->

    <template is="dom-repeat"
              items="[[data]]">
      <template is="dom-repeat"
                items="[[item.indicator_location_data]]"
                as="location">

        <h3>
          <iron-icon icon="maps:place"></iron-icon>
          [[location.location.title]]
        </h3>

        <div class="wrapper">
          <h4>
            Progress in reporting period
            <span>[[item.time_period_start]] - [[item.time_period_end]]<span>
          </h4>
          <h4>
            Total
            <span>[[item.total]]<span>
          </h4>
          <disaggregation-table
            total=[[item.total]]
            data=[[location]]
            mapping=[[item.disagg_lookup_map]]>
          </disaggregation-table>
        </div>

      </template>
    </template>
  </template>

  <script>

    Polymer({
      is: 'ip-reporting-indicator-details',

      behaviors: [
        App.Behaviors.UtilsBehavior,
      ],

      properties: {
        indicatorDetailUrl: {
          type: String,
          computed: '_computeIndicatorReportsUrl(indicatorId)',
        },

        isOpen: {
          type: Boolean,
          observer: '_openChanged',
        },

        indicatorId: Number,

        loading: Boolean,

        data: {
          type: Array,
          value: []
        },

        // locations: {
        //   type: Object,
        //   computed: '_bucketByLocation(data)'
        // }
      },

      _computeIndicatorReportsUrl: function (indicatorId) {
        return App.Endpoints.indicatorReports(indicatorId);
      },

      // _bucketByLocation: function (data) {
      //   // TODO: Fix this.
      //   var self = this;
      //   locations = {}
      //
      //   if (Object.keys(this.data).length > 0) {
      //     this.data.map(function(indicator) {
      //       // The object also has a location object.
      //       indicator.indicator_location_data.map(function(x) {
      //         if (locations[x.location.id]) {
      //           var currentArray = locations[x.location.id];
      //           var newArray = currentArray;
      //           newArray.push(indicator)
      //           locations[x.location.id] = newArray;
      //         } else {
      //           locations[x.location.id] = [indicator];
      //           console.log(indicator)
      //         }
      //       });
      //     });
      //   }

      //   var locationList = [];
      //   var keys = Object.keys(locations)
      //   keys.map(function(i) {
      //     locationList.push(locations[i])
      //   })
      //
      //   return locationList
      // },

      _openChanged: function () {
        var self = this;
        if (this.isOpen) {
          self.loading = true;
          this.$.indicatorDetail.thunk()()
            .then(function (res) {
              self.data = res.data;
              self.loading = false;
            });
            // TODO: error handling.
        } else {
          this.$.indicatorDetail.abort();
        }
      }

    });
  </script>
</dom-module>
